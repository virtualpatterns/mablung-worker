{"version":3,"sources":["../../source/library/child-process.js"],"names":["Configuration","Console","EventEmitter","FileSystem","Is","Stream","Null","ChildProcessSignalError","ChildProcess","constructor","userPath","userParameter","userOption","path","parameter","getParameter","defaultParameter","option","getOption","defaultOption","process","_createProcess","_path","_parameter","_option","_process","_console","_stream","_streamOption","_attach","on","_onMessage","message","onMessage","error","_onDisconnect","log","onDisconnect","_onError","_detach","onError","_onExit","code","signal","null","not","onExit","onTerminate","off","console","pid","isConnected","connected","writeTo","stream","Writable","createWriteStream","stderr","pipe","stdout","send","Promise","resolve","reject","disconnect","kill","emit"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport { Console } from 'console'\nimport EventEmitter from 'events'\nimport FileSystem from 'fs-extra'\nimport Is from '@pwn/is'\nimport Stream from 'stream'\n\nimport { Null } from './null.js'\n\nimport { ChildProcessSignalError } from './error/child-process-signal-error.js'\n\nclass ChildProcess extends EventEmitter {\n\n  constructor(userPath, userParameter = {}, userOption = {}) { // \n    super()\n\n    let path = userPath\n    let parameter = Configuration.getParameter(this.defaultParameter, userParameter)\n    let option = Configuration.getOption(this.defaultOption, userOption)\n\n    let process = this._createProcess(path, parameter, option)\n\n    this._path = path\n    this._parameter = parameter\n    this._option = option\n\n    this._process = process\n\n    this._console = new Null()\n    this._stream = null\n    this._streamOption = null\n\n    this._attach()\n\n  }\n\n  /* c8 ignore next 1 */\n  _createProcess(/* path, parameter, option */) {}\n\n  _attach() {\n\n    this._process.on('message', this._onMessage = (message) => {\n      // this._console.log('ChildProcess.on(\\'message\\', this._onMessage = (message) => { ... })')\n      // this._console.dir(message)\n  \n      try {\n        this.onMessage(message)\n        /* c8 ignore next 3 */\n      } catch (error) {\n        this._console.error(error)\n      }\n\n    })\n\n    this._process.on('disconnect', this._onDisconnect = () => {\n      this._console.log('ChildProcess.on(\\'disconnect\\', this._onDisconnect = () => { ... })')\n  \n      try {\n        this.onDisconnect()\n        /* c8 ignore next 3 */\n      } catch (error) {\n        this._console.error(error)\n      }\n\n    })\n\n    this._process.on('error', this._onError = (error) => {\n      this._console.error('ChildProcess.on(\\'error\\', this._onError = (error) => { ... })')\n      this._console.error(error)\n  \n      try {\n        this._detach()\n        this.onError(error)\n        /* c8 ignore next 3 */\n      } catch (error) {\n        this._console.error(error)\n      } finally {\n        this._console = new Null()\n      }\n\n    })\n\n    this._process.on('exit', this._onExit = (code, signal) => {\n      this._console.log(`ChildProcess.on('exit', this._onExit = (${code}, ${Is.null(signal) ? signal : `'${signal}'`}) => { ... })`)\n\n      try {\n\n        this._detach()\n\n        if (Is.not.null(code)) {\n          this.onExit(code)\n          /* c8 ignore next 5 */\n        } else if (Is.not.null(signal)) {\n          this.onTerminate(signal)\n        } else {\n          this.onExit(0)\n        }\n\n        /* c8 ignore next 3 */\n      } catch (error) {\n        this._console.error(error)\n      } finally {\n        this._console = new Null()\n      }\n\n    })\n\n  }\n\n  _detach() {\n\n    if (this._onExit) {\n      this._process.off('exit', this._onExit)\n      delete this._onExit\n    }\n\n    if (this._onError) {\n      this._process.off('error', this._onError)\n      delete this._onError\n    }\n\n    if (this._onDisconnect) {\n      this._process.off('disconnect', this._onDisconnect)\n      delete this._onDisconnect\n    }\n\n    if (this._onMessage) {\n      this._process.off('message', this._onMessage)\n      delete this._onMessage\n    }\n\n  }\n\n  /* c8 ignore next 3 */\n  get path() {\n    return this._path\n  }\n\n  get defaultParameter() {\n    return {}\n  }\n\n  /* c8 ignore next 3 */\n  get parameter() {\n    return this._parameter\n  }\n\n  get defaultOption() {\n    return {\n      'serialization': 'advanced',\n      'stdio': 'pipe'\n    }\n  }\n\n  get option() {\n    return this._option\n  }\n\n  get console() {\n    return this._console\n  }\n\n  get pid() {\n    return this._process.pid\n  }\n\n  /* c8 ignore next 3 */\n  get isConnected() {\n    return this._process.connected\n  }\n\n  writeTo(path, option = { 'autoClose': true, 'emitClose': true, 'encoding': 'utf8', 'flags': 'a+' }) {\n\n    let stream = null\n\n    switch (true) {\n      /* c8 ignore next 3 */\n      case path instanceof Stream.Writable:\n        stream = path\n        break\n      default:\n        stream = FileSystem.createWriteStream(path, option)\n    }\n\n    this._process.stderr.pipe(stream, { 'end': false })\n    this._process.stdout.pipe(stream, { 'end': false })\n\n    this._console = new Console({\n      'colorMode': false,\n      'ignoreErrors': false,\n      'stderr': stream,\n      'stdout': stream\n    })\n\n    this._stream = stream\n    this._streamOption = option\n        \n  }\n\n  send(message) {\n    // this._console.log('ChildProcess.send(message) { ... }')\n    // this._console.dir(message)\n\n    return new Promise((resolve, reject) => {\n      \n      this._process.send(message, (error) => {\n\n        if (Is.null(error)) {\n          resolve()\n        } else {\n          reject(error)\n        }\n\n      })\n\n    })\n\n  }\n\n  disconnect() {\n    this._process.disconnect()\n  }\n\n  signal(signal) {\n\n    if (this._process.kill(signal)) {\n      // do nothing\n      /* c8 ignore next 3 */\n    } else {\n      throw new ChildProcessSignalError(signal, this._process.pid)\n    }\n\n  }\n  \n  kill(signal = 'SIGINT') {\n    this.signal(signal)\n  }\n\n  onMessage(message) {\n    this.emit('message', message)\n  }\n\n  onDisconnect() {\n    this.emit('disconnect')\n  }\n\n  onError(error) {\n    this.emit('error', error)\n  }\n\n  onExit(code) {\n    this.emit('exit', code)\n  }\n\n  onTerminate(signal) {\n    this.emit('terminate', signal)\n  }\n\n}\n\nexport { ChildProcess }"],"file":"child-process.js"}