{"version":3,"sources":["../../source/library/worker-pool.js"],"names":["Configuration","Is","OS","ChildProcessPool","WorkerClient","WorkerPoolModuleHandler","WorkerPoolParameter","Process","process","WorkerPool","constructor","parameter","getConstructorParameter","_module","_moduleUrl","_createProcess","index","path","option","merge","env","module","moduleUrl","selectProcess","ping","getProcess","pingResult","Promise","allSettled","getConnectedProcess","map","workerClient","fulfilledPingResult","filter","result","status","length","value","reduce","minimumResult","null","cpuUsage","reason","import","url","returnValue","all","Proxy","apply","methodName","release","end","code","uncaughtException","unhandledRejection","disconnect","kill"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport Is from '@pwn/is'\nimport OS from 'os'\n\nimport { ChildProcessPool } from './child-process-pool.js'\nimport { WorkerClient } from './worker-client.js'\nimport { WorkerPoolModuleHandler } from './worker-pool-module-handler.js'\nimport { WorkerPoolParameter } from './worker-pool-parameter.js'\n\nconst Process = process\n\nclass WorkerPool extends ChildProcessPool {\n\n  constructor(...parameter) {\n    super(...WorkerPoolParameter.getConstructorParameter(...parameter))\n\n    this._module = null\n    this._moduleUrl = null\n    \n  }\n\n  _createProcess(index, path, parameter, option) {\n    return new WorkerClient(path, parameter, Configuration.merge(option, { 'env': Configuration.merge(Process.env, { 'WORKER_POOL_INDEX': index }) }))\n  }\n\n  get module() {\n    return this._module\n  }\n\n  get moduleUrl() {\n    return this._moduleUrl\n  }\n\n  async selectProcess(/* methodName, parameter */) {\n    let { index } = await this.ping()\n    return this.getProcess(index)\n  }\n\n  async ping() {\n\n    let pingResult = await Promise.allSettled(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.ping()))\n\n    let fulfilledPingResult = pingResult.filter((result) => result.status === 'fulfilled')\n\n    if (fulfilledPingResult.length > 0) {\n\n      fulfilledPingResult = fulfilledPingResult.map((result) => result.value)\n      fulfilledPingResult = fulfilledPingResult.reduce((minimumResult, result) => Is.null(minimumResult) || result.cpuUsage < minimumResult.cpuUsage ? result : minimumResult, null)\n  \n      return fulfilledPingResult\n\n    } else {\n      throw pingResult[0].reason\n    }\n\n  }\n  \n  async import(url, option = {}) {\n\n    let returnValue = await Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.import(url, option)))\n\n    this._module = new Proxy(this, WorkerPoolModuleHandler)\n    this._moduleUrl = url\n\n    return returnValue\n\n  }\n\n  async apply(methodName, parameter) {\n    return (await this.selectProcess(methodName, parameter)).process.apply(methodName, parameter)\n  }\n\n  async release(option = {}) {\n\n    let returnValue = await Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.release(option)))\n\n    this._module = null\n    this._moduleUrl = null\n\n    return returnValue\n\n  }\n\n  end(code = 0, option = {}) {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.end(code, option)))\n  }\n\n  uncaughtException() {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.uncaughtException()))\n  }\n\n  unhandledRejection() {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.unhandledRejection()))\n  }\n\n  disconnect() {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.disconnect()))\n  }\n\n  kill(...parameter) {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.kill(...parameter)))\n  }\n\n}\n\nexport { WorkerPool }"],"file":"worker-pool.js"}