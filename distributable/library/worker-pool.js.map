{"version":3,"sources":["../../source/library/worker-pool.js"],"names":["Configuration","Is","ChildProcessPool","WorkerClient","WorkerPoolModuleHandler","WorkerPoolParameter","WorkerPoolDisconnectedError","Process","process","WorkerPool","constructor","parameter","getConstructorParameter","_module","Proxy","_createProcess","index","path","option","merge","env","_selectProcessInformation","ping","_getProcessInformation","maximumDuration","value","_getConnectedProcessInformation","forEach","workerClient","module","processInformation","length","pingResult","Promise","all","map","reduce","minimumResult","result","null","cpuUsage","apply","methodName","end","code","disconnect","kill"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport Is from '@pwn/is'\n\nimport { ChildProcessPool } from './child-process-pool.js'\nimport { WorkerClient } from './worker-client.js'\nimport { WorkerPoolModuleHandler } from './worker-pool-module-handler.js'\nimport { WorkerPoolParameter } from './worker-pool-parameter.js'\n\nimport { WorkerPoolDisconnectedError } from './error/worker-pool-disconnected-error.js'\n\nconst Process = process\n\nclass WorkerPool extends ChildProcessPool {\n\n  constructor(...parameter) {\n    super(...WorkerPoolParameter.getConstructorParameter(...parameter))\n\n    this._module = new Proxy(this, WorkerPoolModuleHandler)\n    \n  }\n\n  _createProcess(index, path, parameter, option) {\n    return new WorkerClient(path, parameter, Configuration.merge(option, { 'env': Configuration.merge(Process.env, { 'WORKER_POOL_INDEX': index }) }))\n  }\n\n  async _selectProcessInformation(/* methodName, parameter */) {\n    let { index } = await this.ping()\n    return this._getProcessInformation(index)\n  }\n\n  get maximumDuration() {\n    return this.option.maximumDuration\n  }\n\n  set maximumDuration(value) {\n    this.option.maximumDuration = value\n    this._getConnectedProcessInformation().forEach(({ process: workerClient }) => workerClient.maximumDuration = value)\n  }\n\n  get module() {\n    return this._module\n  }\n\n  async ping() {\n\n    let processInformation = this._getConnectedProcessInformation()\n\n    if (processInformation.length > 0) {\n\n      let pingResult = null\n      pingResult = await Promise.all(processInformation.map(({ process: workerClient }) => workerClient.ping()))\n      pingResult = pingResult.reduce((minimumResult, result) => Is.null(minimumResult) || result.cpuUsage < minimumResult.cpuUsage ? result : minimumResult, null)\n  \n      return pingResult\n\n    } else {\n      throw new WorkerPoolDisconnectedError()\n    }\n\n  }\n  \n  // async import(url, option = {}) {\n\n  //   let processInformation = this._getConnectedProcessInformation()\n\n  //   if (processInformation.length > 0) {\n\n  //     let returnValue = await Promise.all(processInformation.map(({ process: workerClient }) => workerClient.import(url, option)))\n\n  //     this._module = new Proxy(this, WorkerPoolModuleHandler)\n  //     this._moduleUrl = url\n  \n  //     return returnValue\n\n  //   } else {\n  //     throw new WorkerPoolDisconnectedError()\n  //   }\n\n  // }\n\n  async apply(methodName, parameter) {\n    return (await this._selectProcessInformation(methodName, parameter)).process.apply(methodName, parameter)\n  }\n\n  // async release(option = {}) {\n\n  //   let processInformation = this._getConnectedProcessInformation()\n\n  //   if (processInformation.length > 0) {\n\n  //     let returnValue = await Promise.all(processInformation.map(({ process: workerClient }) => workerClient.release(option)))\n\n  //     this._module = null\n  //     this._moduleUrl = null\n  \n  //     return returnValue\n\n  //   } else {\n  //     throw new WorkerPoolDisconnectedError()\n  //   }\n\n  // }\n\n  end(code = 0, option = {}) {\n\n    let processInformation = this._getConnectedProcessInformation()\n\n    if (processInformation.length > 0) {\n      return Promise.all(processInformation.map(({ process: workerClient }) => workerClient.end(code, option)))\n    } else {\n      throw new WorkerPoolDisconnectedError()\n    }\n\n  }\n\n  // uncaughtException() {\n\n  //   let processInformation = this._getConnectedProcessInformation()\n\n  //   if (processInformation.length > 0) {\n  //     return Promise.all(processInformation.map(({ process: workerClient }) => workerClient.uncaughtException()))\n  //   } else {\n  //     throw new WorkerPoolDisconnectedError()\n  //   }\n\n  // }\n\n  // unhandledRejection() {\n\n  //   let processInformation = this._getConnectedProcessInformation()\n\n  //   if (processInformation.length > 0) {\n  //     return Promise.all(processInformation.map(({ process: workerClient }) => workerClient.unhandledRejection()))\n  //   } else {\n  //     throw new WorkerPoolDisconnectedError()\n  //   }\n\n  // }\n\n  disconnect() {\n\n    let processInformation = this._getConnectedProcessInformation()\n\n    if (processInformation.length > 0) {\n      return Promise.all(processInformation.map(({ process: workerClient }) => workerClient.disconnect()))\n    } else {\n      throw new WorkerPoolDisconnectedError()\n    }\n\n  }\n\n  kill(...parameter) {\n\n    let processInformation = this._getConnectedProcessInformation()\n\n    if (processInformation.length > 0) {\n      return Promise.all(processInformation.map(({ process: workerClient }) => workerClient.kill(...parameter)))\n    } else {\n      throw new WorkerPoolDisconnectedError()\n    }\n\n  }\n\n}\n\nexport { WorkerPool }"],"file":"worker-pool.js"}