{"version":3,"sources":["../../source/library/worker-pool.js"],"names":["Configuration","Is","OS","ChildProcessPool","WorkerClient","WorkerPoolModuleHandler","WorkerPoolParameter","Process","process","WorkerPool","constructor","parameter","getConstructorParameter","_module","_moduleUrl","_createProcess","index","path","option","merge","env","maximumDuration","value","module","moduleUrl","selectProcess","ping","getProcess","pingResult","Promise","allSettled","getConnectedProcess","map","workerClient","fulfilledPingResult","filter","result","status","length","reduce","minimumResult","null","cpuUsage","reason","import","url","returnValue","all","Proxy","apply","methodName","release","end","code","uncaughtException","unhandledRejection","disconnect","kill"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport Is from '@pwn/is'\nimport OS from 'os'\n\nimport { ChildProcessPool } from './child-process-pool.js'\nimport { WorkerClient } from './worker-client.js'\nimport { WorkerPoolModuleHandler } from './worker-pool-module-handler.js'\nimport { WorkerPoolParameter } from './worker-pool-parameter.js'\n\nconst Process = process\n\nclass WorkerPool extends ChildProcessPool {\n\n  constructor(...parameter) {\n    super(...WorkerPoolParameter.getConstructorParameter(...parameter))\n\n    this._module = null\n    this._moduleUrl = null\n    \n  }\n\n  _createProcess(index, path, parameter, option) {\n    return new WorkerClient(path, parameter, Configuration.merge(option, { 'env': Configuration.merge(Process.env, { 'WORKER_POOL_INDEX': index }) }))\n  }\n\n  get maximumDuration() {\n    return this.option.maximumDuration\n  }\n\n  set maximumDuration(value) {\n    this.option.maximumDuration = value\n  }\n\n  get module() {\n    return this._module\n  }\n\n  get moduleUrl() {\n    return this._moduleUrl\n  }\n\n  async selectProcess(/* methodName, parameter */) {\n    let { index } = await this.ping()\n    return this.getProcess(index)\n  }\n\n  async ping() {\n\n    let pingResult = await Promise.allSettled(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.ping()))\n\n    let fulfilledPingResult = pingResult.filter((result) => result.status === 'fulfilled')\n\n    if (fulfilledPingResult.length > 0) {\n\n      fulfilledPingResult = fulfilledPingResult.map((result) => result.value)\n      fulfilledPingResult = fulfilledPingResult.reduce((minimumResult, result) => Is.null(minimumResult) || result.cpuUsage < minimumResult.cpuUsage ? result : minimumResult, null)\n  \n      return fulfilledPingResult\n\n    } else {\n      throw pingResult[0].reason\n    }\n\n  }\n  \n  async import(url, option = {}) {\n\n    let returnValue = await Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.import(url, option)))\n\n    this._module = new Proxy(this, WorkerPoolModuleHandler)\n    this._moduleUrl = url\n\n    return returnValue\n\n  }\n\n  async apply(methodName, parameter) {\n    return (await this.selectProcess(methodName, parameter)).process.apply(methodName, parameter)\n  }\n\n  async release(option = {}) {\n\n    let returnValue = await Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.release(option)))\n\n    this._module = null\n    this._moduleUrl = null\n\n    return returnValue\n\n  }\n\n  end(code = 0, option = {}) {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.end(code, option)))\n  }\n\n  uncaughtException() {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.uncaughtException()))\n  }\n\n  unhandledRejection() {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.unhandledRejection()))\n  }\n\n  disconnect() {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.disconnect()))\n  }\n\n  kill(...parameter) {\n    return Promise.all(this.getConnectedProcess().map(({ process: workerClient }) => workerClient.kill(...parameter)))\n  }\n\n}\n\nexport { WorkerPool }"],"file":"worker-pool.js"}