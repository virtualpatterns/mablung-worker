{"version":3,"sources":["../../source/library/worker-server.js"],"names":["PascalCase","DefaultChangeCase","ModuleChangeCase","Process","process","WorkerServer","constructor","userOption","_option","Configuration","getOption","defaultOption","_module","_modulePath","_attach","on","__onMessage","message","_detachReadyInterval","_onMessage","error","console","__onDisconnect","_detachDisconnect","__onExit","_detach","_readyInterval","setInterval","send","readyInterval","clearInterval","off","import","path","module","default","Promise","resolve","reject","Is","null","WorkerServerNoIPCChannelError","methodName","type","_onPing","cpuUsage","user","system","returnValue","env","WORKER_POOL_INDEX","parseInt","pid","_onApply","apply","parameter","_onExit","exit","code"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport { Is } from '@virtualpatterns/mablung-is'\nimport DefaultChangeCase, * as ModuleChangeCase from 'change-case'\n// import URL from 'url'\n\nimport { WorkerServerNoIPCChannelError } from './error/worker-server-no-ipc-channel-error.js'\n\nconst { 'pascalCase': PascalCase } = DefaultChangeCase || ModuleChangeCase\nconst Process = process\n\nclass WorkerServer {\n\n  constructor(userOption = {}) {\n\n    this._option = Configuration.getOption(this.defaultOption, userOption)\n\n    this._module = null\n    this._modulePath = null\n\n    this._attach()\n\n  }\n\n  get defaultOption() {\n    return { 'readyInterval': 1000 }\n  }\n\n  _attach() {\n\n    Process.on('message', this.__onMessage = async (message) => {\n      // console.log('WorkerServer.on(\\'message\\', this.__onMessage = async (message) => { ... })')\n      // console.dir(message)\n\n      try {\n        this._detachReadyInterval()   \n        await this._onMessage(message) \n      /* c8 ignore next 3 */\n      } catch(error) {\n        console.error(error)\n      }\n\n    })\n\n    Process.on('disconnect', this.__onDisconnect = () => {\n      // console.log('WorkerServer.on(\\'disconnect\\', this.__onDisconnect = () => { ... })')\n\n      try {\n        this._detachReadyInterval()   \n        this._detachDisconnect()    \n      /* c8 ignore next 3 */\n      } catch(error) {\n        console.error(error)\n      }\n      \n    })\n\n    Process.on('exit', this.__onExit = (/* code */) => {\n      // console.log(`WorkerServer.on('exit', this.__onExit = (${code}) => { ... })`)\n\n      try {\n        this._detach()\n      /* c8 ignore next 3 */\n      } catch(error) {\n        console.error(error)\n      }\n        \n    })\n\n    this._readyInterval = setInterval(async () => {\n\n      try {\n        await this.send({ 'type': 'ready' })\n      /* c8 ignore next 4 */\n      } catch (error) {\n        this._detachReadyInterval()\n        console.error(error)\n      }\n\n    }, this._option.readyInterval)\n\n  }\n\n  _detachReadyInterval() {\n\n    if (this._readyInterval) {\n      clearInterval(this._readyInterval)\n      delete this._readyInterval\n    }\n\n  }\n\n  _detachDisconnect() {\n\n    if (this.__onDisconnect) {\n      Process.off('disconnect', this.__onDisconnect)\n      delete this.__onDisconnect\n    }\n\n  }\n\n  _detach() {\n\n    this._detachReadyInterval()    \n\n    if (this.__onExit) {\n      Process.off('exit', this.__onExit)\n      delete this.__onExit\n    }\n\n    this._detachDisconnect()\n\n    if (this.__onMessage) {\n      Process.off('message', this.__onMessage)\n      delete this.__onMessage\n    }\n\n  }\n\n  async import(path) {\n\n    let module = null\n    module = await import(path) // URL.pathToFileURL(path))\n    module = module.default || module\n\n    this._module = module\n    this._modulePath = path\n\n  }\n\n  send(message) {\n    // console.log('WorkerServer.send(message) { ... }')\n    // console.dir(message)\n\n    return new Promise((resolve, reject) => {\n\n      if (Process.send) {\n\n        Process.send(message, (error) => {\n\n          if (Is.null(error)) {\n            resolve()\n          /* c8 ignore next 3 */\n          } else {\n            reject(error)\n          }\n\n        })\n\n      /* c8 ignore next 3 */\n      } else {\n        reject(new WorkerServerNoIPCChannelError())\n      }\n\n    })\n\n  }\n\n  _onMessage(message) {\n    let methodName = `_on${PascalCase(message.type)}`\n    return this[methodName](message)\n  }\n\n  async _onPing(message) {\n\n    let cpuUsage = null\n    cpuUsage = Process.cpuUsage()\n    cpuUsage = (cpuUsage.user + cpuUsage.system) / 2.0\n\n    message.returnValue = { 'index': Process.env.WORKER_POOL_INDEX ? parseInt(Process.env.WORKER_POOL_INDEX) : 0, 'pid': Process.pid, 'cpuUsage': cpuUsage }\n\n    await this.send(message)\n\n  }\n\n  async _onApply(message) {\n\n    try {\n\n      let returnValue = null\n      returnValue = this._module[message.methodName].apply(this._module, message.parameter)\n      returnValue = returnValue instanceof Promise ? await returnValue : returnValue\n\n      delete message.error\n      message.returnValue = returnValue\n\n    } catch (error) {\n\n      message.error = error\n      delete message.returnValue\n\n    }\n\n    await this.send(message)\n\n  }\n\n  async _onExit(message) {\n\n    try {\n      Process.exit(message.code || 0)\n    /* c8 ignore next 3 */\n    } catch (error) {\n      console.error(error)\n    }\n\n  }\n\n}\n\nexport default WorkerServer"],"file":"worker-server.cjs"}