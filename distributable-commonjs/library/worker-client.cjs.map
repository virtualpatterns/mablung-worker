{"version":3,"sources":["../../source/library/worker-client.js"],"names":["PascalCase","DefaultChangeCase","ModuleChangeCase","WorkerClient","ForkedProcess","constructor","parameter","WorkerClientParameter","getConstructorParameter","_isReady","_module","Proxy","WorkerClientModuleHandler","_defaultOption","Configuration","merge","_onMessage","message","methodName","type","_onReady","emit","_onPing","_onApply","_onError","error","_onReject","WorkerClientInternalError","_onDisconnect","WorkerClientDisconnectedError","_onExit","code","WorkerClientExitedError","_onKill","signal","WorkerClientKilledError","maximumDuration","option","value","module","whenReady","whenMessageType","Promise","resolve","reject","onMessage","onReject","timeout","on","off","clearTimeout","setTimeout","WorkerClientDurationExceededError","whenRejected","errorClass","WorkerClientRejectedError","send","requestMessage","responsePromise","sendPromise","responseMessage","all","returnValue","ping","apply","disconnect","exit","kill"],"mappings":"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","sourcesContent":["import { Configuration } from '@virtualpatterns/mablung-configuration'\nimport { ForkedProcess } from './forked-process.js'\nimport { WorkerClientModuleHandler } from './worker-client-module-handler.js'\nimport { WorkerClientParameter } from './worker-client-parameter.js'\nimport DefaultChangeCase, * as ModuleChangeCase from 'change-case'\n\nimport { WorkerClientDurationExceededError } from './error/worker-client-duration-exceeded-error.js'\nimport { WorkerClientRejectedError } from './error/worker-client-rejected-error.js'\nimport { WorkerClientDisconnectedError } from './error/worker-client-disconnected-error.js'\nimport { WorkerClientInternalError } from './error/worker-client-internal-error.js'\nimport { WorkerClientExitedError } from './error/worker-client-exited-error.js'\nimport { WorkerClientKilledError } from './error/worker-client-killed-error.js'\n\nconst { 'pascalCase': PascalCase } = DefaultChangeCase || ModuleChangeCase\n\nclass WorkerClient extends ForkedProcess {\n\n  constructor(...parameter) {\n    super(...WorkerClientParameter.getConstructorParameter(...parameter))\n\n    this._isReady = false\n\n    this._module = new Proxy(this, WorkerClientModuleHandler)\n\n  }\n\n  get _defaultOption() {\n    return Configuration.merge(super._defaultOption, { 'maximumDuration': 10000 })\n  }\n\n  _onMessage(message) {\n\n    let methodName = `_on${PascalCase(message.type)}`\n    this[methodName](message)\n\n    super._onMessage(message)\n\n  }\n\n  _onReady(message) {\n    this.emit('ready', message)\n  }\n\n  _onPing(message) {\n    this.emit('ping', message)\n  }\n\n  _onApply(message) {\n    this.emit('apply', message)\n  }\n\n  _onError(error) {\n    this._onReject(new WorkerClientInternalError(error))\n    super._onError(error)\n  }\n\n  _onDisconnect() {\n    this._onReject(new WorkerClientDisconnectedError())\n    super._onDisconnect()\n  }\n\n  _onExit(code) {\n    this._onReject(new WorkerClientExitedError(code))\n    super._onExit(code)\n  }\n\n  _onKill(signal) {\n    this._onReject(new WorkerClientKilledError(signal))\n    super._onKill(signal)\n  }\n\n  _onReject(error) {\n    this.emit('reject', error)\n  }\n\n  get maximumDuration() {\n    return this.option.maximumDuration\n  }\n\n  set maximumDuration(value) {\n    this.option.maximumDuration = value\n  }\n\n  get module() {\n    return this._module\n  }\n\n  async whenReady() {\n\n    if (!this._isReady) {\n      await this.whenMessageType('ready')\n      this._isReady = true\n    }\n\n  }\n\n  whenMessageType(type) {\n    // this.console.log(`WorkerClient.whenMessageType('${type}') { ... }`)\n\n    return new Promise((resolve, reject) => {\n\n      let onMessage = null\n      let onReject = null\n      let timeout = null\n   \n      this.on('message', onMessage = (message) => {\n        // this.console.log('WorkerClient.on(\\'message\\', onMessage = (message) => { ... })')\n        // this.console.dir(message)\n\n        if (message.type === type) {\n\n          this.off('message', onMessage)\n          onMessage = null\n\n          this.off('reject', onReject)\n          onReject = null\n\n          if (this.maximumDuration > 0) {\n            clearTimeout(timeout)\n            timeout = null\n          }\n          \n          resolve(message)\n    \n        }\n\n      })\n\n      this.on('reject', onReject = (error) => {\n        // this.console.error('WorkerClient.on(\\'reject\\', onReject = (error) => { ... })')\n        // this.console.error(error)\n  \n        this.off('message', onMessage)\n        onMessage = null\n\n        this.off('reject', onReject)\n        onReject = null\n\n        if (this.maximumDuration > 0) {\n          clearTimeout(timeout)\n          timeout = null\n        }\n      \n        reject(error)\n  \n      })\n\n      if (this.maximumDuration > 0) {\n  \n        timeout = setTimeout(() => {\n\n          this.off('message', onMessage)\n          onMessage = null\n  \n          this.off('reject', onReject)\n          onReject = null\n  \n          clearTimeout(timeout)\n          timeout = null\n          \n          reject(new WorkerClientDurationExceededError(this.maximumDuration))\n    \n        }, this.maximumDuration)\n  \n      }\n\n    })\n\n  }\n\n  whenRejected(errorClass = WorkerClientRejectedError) {\n    // this.console.log(`WorkerClient.whenRejected(${errorClass.name}) { ... }`)\n\n    return new Promise((resolve, reject) => {\n\n      let onReject = null\n      let timeout = null\n\n      this.on('reject', onReject = (error) => {\n        // this.console.error('WorkerClient.on(\\'reject\\', onReject = (error) => { ... })')\n        // this.console.error(error)\n\n        if (error instanceof errorClass) {\n\n          this.off('reject', onReject)\n          onReject = null\n  \n          if (this.maximumDuration > 0) {\n            clearTimeout(timeout)\n            timeout = null\n          }\n        \n          resolve(error)\n  \n        }\n  \n      })\n\n      if (this.maximumDuration > 0) {\n  \n        timeout = setTimeout(() => {\n\n          this.off('reject', onReject)\n          onReject = null\n\n          clearTimeout(timeout)\n          timeout = null\n          \n          reject(new WorkerClientDurationExceededError(this.maximumDuration))\n    \n        }, this.maximumDuration)\n\n      }\n\n    })\n\n  }\n\n  async send(requestMessage) {\n\n    let responsePromise = this.whenMessageType(requestMessage.type)\n    let sendPromise = super.send(requestMessage)\n\n    let [, responseMessage] = await Promise.all([ sendPromise, responsePromise ])\n\n    if (responseMessage.error) {\n      throw responseMessage.error\n    }\n\n    return responseMessage.returnValue\n\n  }\n\n  async ping() {\n    await this.whenReady()\n    return this.send({ 'type': 'ping' })\n  }\n\n  async apply(methodName, parameter) {\n    await this.whenReady()\n    return this.send({ 'type': 'apply', 'methodName': methodName, 'parameter': parameter })\n  }\n\n  disconnect() {\n    super.disconnect()\n    return this.whenRejected(WorkerClientDisconnectedError)\n  }\n\n  async exit(code = 0) {\n    await this.whenReady()\n    await super.send({ 'type': 'exit', 'code': code }) // there will be no response\n    await this.whenRejected(WorkerClientExitedError)\n  }\n\n  kill(...parameter) {\n    super.kill(...parameter)\n    return this.whenRejected(WorkerClientKilledError)\n  }\n\n}\n\nexport { WorkerClient }"],"file":"worker-client.cjs"}